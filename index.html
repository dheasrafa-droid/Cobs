<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DSRT - MultiBlock Editor (Prototype)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/6.0.0/fabric.min.js"></script>
<style>
  :root{ --bg:#0f172a; --card:#0b1220; }
  body{ font-family:Inter,system-ui,Arial; background:#0f172a; color:#e6eef8; margin:0; padding:18px; -webkit-font-smoothing:antialiased; }
  .wrap{ max-width:1200px; margin:0 auto; background:#071028; border-radius:12px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,0.6); }
  header{ display:flex; justify-content:space-between; gap:12px; align-items:center; margin-bottom:12px; }
  .title{ font-weight:700; font-size:18px; color:#dbeafe }
  .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .btn{ background:#1e293b; color:#e6eef8; padding:8px 12px; border-radius:8px; cursor:pointer; border:1px solid rgba(255,255,255,0.03); }
  .btn.primary{ background:#2563eb; }
  .layout{ display:grid; grid-template-columns: 1fr 420px; gap:12px; }
  @media(max-width:980px){ .layout{ grid-template-columns: 1fr; } }
  .canvas-area{ background:#0b1220; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); display:flex; justify-content:center; align-items:center; min-height:360px; }
  canvas{ max-width:100%; border-radius:6px; }
  .right-panel{ display:flex; flex-direction:column; gap:12px; }
  .tiles{ display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top:12px; }
  @media(max-width:720px){ .tiles{ grid-template-columns: repeat(3,1fr); } }
  .tile{ background:#071a2b; border-radius:8px; padding:12px; cursor:pointer; text-align:center; border:1px solid rgba(255,255,255,0.03); }
  .tile h4{ font-size:13px; margin:6px 0 0 0; color:#cfe7ff; }
  .subtools{ margin-top:12px; background:#071a2b; border-radius:8px; padding:10px; min-height:54px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; border:1px solid rgba(255,255,255,0.03); }
  .subtool{ background:#07263d; padding:8px 10px; border-radius:999px; cursor:pointer; color:#cfe7ff; font-size:13px; border:1px solid rgba(255,255,255,0.02); }
  .subtool.active{ background:#1e40af; }
  .panel{ margin-top:12px; background:#071a2b; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); }
  label{ display:flex; align-items:center; gap:8px; color:#cbd5e1; font-size:13px; }
  input[type="range"]{ width:100%; }
  .small{ font-size:12px; color:#9fb1cc; }
  .input-color{ width:36px; height:28px; padding:0; border:none; background:none; }
  .drop{ background:#0b1220; border:1px solid rgba(255,255,255,0.03); padding:6px 8px; border-radius:6px; color:#cfe7ff; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">DSRT â€” MultiBlock Editor (Prototype)</div>
    <div class="controls">
      <label class="btn">
        Upload <input id="uploader" type="file" accept="image/*" style="display:none" />
      </label>
      <button id="checker" class="btn">Toggle Checker</button>
      <button id="reset" class="btn">Reset Canvas</button>
      <button id="download" class="btn primary">Download</button>
    </div>
  </header>

  <div class="layout">
    <div>
      <div class="canvas-area">
        <canvas id="c"></canvas>
      </div>

      <!-- subtools row + controls -->
      <div class="subtools" id="subtools" style="display:none"></div>

      <div class="panel" id="controlPanel" style="display:none"></div>
    </div>

    <aside class="right-panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:600;color:#cfe7ff">9 Blok Fitur</div>
        <div class="small">Klik blok â†’ pilih subfitur</div>
      </div>

      <div class="tiles" id="tiles">
        <!-- tiles populated by JS -->
      </div>

      <div class="panel small">
        Tips: Upload gambar, pilih blok (mis. Rotate), lalu pilih subfitur (mis. Rotate Right). Gunakan slider untuk nilai.
      </div>
    </aside>
  </div>
</div>

<script>
// ---------- Canvas init ----------
const canvas = new fabric.Canvas('c', { backgroundColor:'#ffffff' });
function resizeCanvas() {
  const containerWidth = Math.min(900, window.innerWidth - 60);
  const w = Math.max(360, containerWidth);
  const h = Math.round(w * 9 / 16);
  canvas.setWidth(w);
  canvas.setHeight(h);
  canvas.renderAll();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// ---------- helpers ----------
function activeImage() {
  return canvas.getObjects().find(o => o.type === 'image');
}
function activeObject() {
  return canvas.getActiveObject();
}
function ensureFilter(img, FilterClass) {
  if(!img || img.type !== 'image') return null;
  img.filters = img.filters || [];
  let f = img.filters.find(x => x && x.type === FilterClass.type);
  if(!f) { f = new FilterClass(); img.filters.push(f); }
  return f;
}
const F = fabric.Image.filters;

// ---------- uploader ----------
document.getElementById('uploader').addEventListener('change', (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  fabric.Image.fromURL(url, img => {
    img.set({ left: 20, top: 20, selectable:true });
    const s = Math.min((canvas.width-40)/img.width, (canvas.height-40)/img.height, 1);
    if(s < 1) img.scale(s);
    canvas.clear(); // single image flow for prototype
    canvas.add(img).setActiveObject(img);
    canvas.renderAll();
  });
});

// ---------- checker / reset / download ----------
let checkerOn = false;
document.getElementById('checker').onclick = ()=>{
  checkerOn = !checkerOn;
  if(!checkerOn) { canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas)); return; }
  const size = 16;
  const pc = document.createElement('canvas'); pc.width = pc.height = size*2;
  const ctx = pc.getContext('2d');
  ctx.fillStyle = '#e6eef8'; ctx.fillRect(0,0,pc.width,pc.height);
  ctx.fillStyle = '#d1e8ff'; ctx.fillRect(0,0,size,size);
  ctx.fillRect(size,size,size,size);
  canvas.setBackgroundColor(new fabric.Pattern({ source: pc, repeat:'repeat' }), canvas.renderAll.bind(canvas));
}
document.getElementById('reset').onclick = ()=>{ canvas.clear(); canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas)); }
document.getElementById('download').onclick = ()=>{
  const link = document.createElement('a');
  link.href = canvas.toDataURL({ format:'png', multiplier:1 });
  link.download = 'dsrt_export.png';
  link.click();
}

// ---------- Tiles + subfeatures model ----------
const TILES = [
  { key:'rotate', title:'Rotate', icon:'â†»', subs:[
      { id:'rotateLeft', label:'Rotate Left 90' },
      { id:'rotateRight', label:'Rotate Right 90' },
      { id:'flipH', label:'Flip Horizontal' },
      { id:'flipV', label:'Flip Vertical' },
      { id:'straighten', label:'Straighten (slider)' },
      { id:'angle_snap', label:'Angle Snap (toggle)' },
      { id:'reset_transform', label:'Reset Transform' }
    ]},
  { key:'crop', title:'Crop', icon:'â–­', subs:[
      { id:'free_crop', label:'Free Crop' },
      { id:'ratio_1_1', label:'1:1 Crop' },
      { id:'ratio_4_3', label:'4:3 Crop' },
      { id:'apply_crop', label:'Apply Crop' },
    ]},
  { key:'adjust', title:'Adjust', icon:'âš™', subs:[
      { id:'brightness', label:'Brightness (slider)' },
      { id:'contrast', label:'Contrast (slider)' },
      { id:'saturation', label:'Saturation (slider)' },
      { id:'hue', label:'Hue (slider)' },
    ]},
  { key:'filter', title:'Filter', icon:'âœ¦', subs:[
      { id:'blur', label:'Gaussian Blur (slider)' },
      { id:'sharpen', label:'Sharpen (slider)' },
      { id:'bw', label:'B&W (toggle)' },
      { id:'vintage', label:'Vintage (overlay)' },
    ]},
  { key:'effect', title:'Effect', icon:'â˜…', subs:[
      { id:'vignette', label:'Vignette (slider)' },
      { id:'grain', label:'Grain (toggle)' },
      { id:'glow', label:'Glow (toggle)' }
    ]},
  { key:'text', title:'Text', icon:'T', subs:[
      { id:'add_text', label:'Add Text' },
      { id:'font_size', label:'Font Size (slider)' },
      { id:'font_color', label:'Font Color' }
    ]},
  { key:'sticker', title:'Sticker', icon:'ðŸ“Ž', subs:[
      { id:'add_sticker', label:'Add Sample Sticker' },
      { id:'sticker_scale', label:'Sticker Scale (slider)' }
    ]},
  { key:'brush', title:'Brush', icon:'âœŽ', subs:[
      { id:'draw_mode', label:'Toggle Draw' },
      { id:'brush_size', label:'Size (slider)' },
      { id:'brush_color', label:'Color' }
    ]},
  { key:'frame', title:'Frame', icon:'â–¢', subs:[
      { id:'add_frame', label:'Add Frame' },
      { id:'remove_frame', label:'Remove Frame' }
    ]}
];

// render tiles
const tilesEl = document.getElementById('tiles');
TILES.forEach(t=>{
  const d = document.createElement('div');
  d.className = 'tile';
  d.innerHTML = `<div style="font-size:20px">${t.icon}</div><h4>${t.title}</h4>`;
  d.onclick = ()=> selectTile(t);
  tilesEl.appendChild(d);
});

// subtools and controls
const subtoolsEl = document.getElementById('subtools');
const controlPanel = document.getElementById('controlPanel');

let currentTile = null;
let cropRect = null;
let frameObject = null;

// select tile
function selectTile(tile) {
  currentTile = tile;
  // render subtools
  subtoolsEl.style.display = 'flex';
  subtoolsEl.innerHTML = '';
  tile.subs.forEach((s, idx)=>{
    const el = document.createElement('div');
    el.className = 'subtool';
    el.textContent = s.label;
    el.dataset.subid = s.id;
    el.onclick = ()=> selectSub(tile, s, el);
    subtoolsEl.appendChild(el);
  });
  // clear control panel
  controlPanel.style.display = 'none';
  controlPanel.innerHTML = '';
  // scroll to subtools
  subtoolsEl.scrollIntoView({behavior:'smooth', block:'center'});
}

// select subfeature
function selectSub(tile, sub, elNode) {
  // highlight active subtool
  document.querySelectorAll('.subtool').forEach(x=>x.classList.remove('active'));
  elNode.classList.add('active');

  // show control UI for sub
  controlPanel.style.display = 'block';
  controlPanel.innerHTML = ''; // fresh

  // implement behaviors for major subs (functional)
  switch(sub.id) {
    // ---------- ROTATE ----------
    case 'rotateLeft':
      controlPanel.appendChild(elementButton('Rotate Left 90Â°', ()=>{ const o = activeObject() || activeImage(); if(o){ o.rotate(((o.angle||0)-90)%360); o.setCoords(); canvas.renderAll(); } }));
      break;
    case 'rotateRight':
      controlPanel.appendChild(elementButton('Rotate Right 90Â°', ()=>{ const o = activeObject() || activeImage(); if(o){ o.rotate(((o.angle||0)+90)%360); o.setCoords(); canvas.renderAll(); } }));
      break;
    case 'flipH':
      controlPanel.appendChild(elementButton('Flip Horizontal', ()=>{ const o = activeObject() || activeImage(); if(o){ o.set('flipX', !(o.flipX)); canvas.renderAll(); } }));
      break;
    case 'flipV':
      controlPanel.appendChild(elementButton('Flip Vertical', ()=>{ const o = activeObject() || activeImage(); if(o){ o.set('flipY', !(o.flipY)); canvas.renderAll(); } }));
      break;
    case 'straighten':
      controlPanel.appendChild(elementSlider('Straighten (Â°)', -45, 45, 0, v=>{ const o = activeObject() || activeImage(); if(o){ o.rotate(v); o.setCoords(); canvas.renderAll(); } }));
      controlPanel.appendChild(elementButton('Reset Angle', ()=>{ const o = activeObject() || activeImage(); if(o){ o.rotate(0); o.setCoords(); canvas.renderAll(); } }));
      break;
    case 'angle_snap':
      controlPanel.appendChild(elementToggle('Angle Snap (30Â°)', false, checked=>{ /* placeholder for snap logic */ alert('Angle Snap toggled: '+checked); }));
      break;
    case 'reset_transform':
      controlPanel.appendChild(elementButton('Reset Transform', ()=>{ const o = activeObject() || activeImage(); if(o){ o.set({ angle:0, scaleX:1, scaleY:1, skewX:0, skewY:0, flipX:false, flipY:false }); o.setCoords(); canvas.renderAll(); } }));
      break;

    // ---------- CROP ----------
    case 'free_crop':
      controlPanel.appendChild(elementButton('Make Free Crop Area', ()=>{ if(cropRect) canvas.remove(cropRect); cropRect = new fabric.Rect({ left:40, top:40, width: Math.min(300, canvas.width-80), height: Math.min(220, canvas.height-80), fill:'rgba(37,99,235,0.12)', stroke:'#2563eb', strokeDashArray:[6,6] }); cropRect.setControlsVisibility({ mtr:false }); canvas.add(cropRect).setActiveObject(cropRect); }));
      break;
    case 'ratio_1_1':
      controlPanel.appendChild(elementButton('Create 1:1 Crop Area', ()=>{ if(cropRect) canvas.remove(cropRect); const size = Math.min(360, canvas.width-60); cropRect = new fabric.Rect({ left:(canvas.width-size)/2, top:(canvas.height-size)/2, width:size, height:size, fill:'rgba(16,185,129,0.08)', stroke:'#10b981', strokeDashArray:[6,6] }); cropRect.setControlsVisibility({ mtr:false }); canvas.add(cropRect).setActiveObject(cropRect); }));
      break;
    case 'ratio_4_3':
      controlPanel.appendChild(elementButton('Create 4:3 Crop Area', ()=>{ if(cropRect) canvas.remove(cropRect); const cw = Math.min(420, canvas.width-60); const ch = Math.round(cw * 3/4); cropRect = new fabric.Rect({ left:(canvas.width-cw)/2, top:(canvas.height-ch)/2, width:cw, height:ch, fill:'rgba(99,102,241,0.08)', stroke:'#6366f1', strokeDashArray:[6,6] }); cropRect.setControlsVisibility({ mtr:false }); canvas.add(cropRect).setActiveObject(cropRect); }));
      break;
    case 'apply_crop':
      controlPanel.appendChild(elementButton('Apply Crop', ()=>{ const sel = cropRect || canvas.getActiveObject(); if(!sel || sel.type !== 'rect'){ alert('Pilih area crop (rect) terlebih dahulu.'); return; } const data = canvas.toDataURL({ left: sel.left, top: sel.top, width: sel.width*sel.scaleX, height: sel.height*sel.scaleY }); fabric.Image.fromURL(data, img=>{ canvas.clear(); canvas.add(img).setActiveObject(img); cropRect = null; canvas.renderAll(); }); }));
      break;

    // ---------- ADJUST ----------
    case 'brightness':
      controlPanel.appendChild(elementSlider('Brightness', -1, 1, 0, v=>{ const img = activeImage(); if(!img) return; const f = ensureFilter(img, F.Brightness); if(f){ f.brightness = v; img.applyFilters(); canvas.renderAll(); } }));
      break;
    case 'contrast':
      controlPanel.appendChild(elementSlider('Contrast', -1, 1, 0, v=>{ const img = activeImage(); if(!img) return; const f = ensureFilter(img, F.Contrast); if(f){ f.contrast = v; img.applyFilters(); canvas.renderAll(); } }));
      break;
    case 'saturation':
      controlPanel.appendChild(elementSlider('Saturation', -1, 1, 0, v=>{ const img = activeImage(); if(!img) return; const f = ensureFilter(img, F.Saturation); if(f){ f.saturation = v; img.applyFilters(); canvas.renderAll(); } }));
      break;
    case 'hue':
      controlPanel.appendChild(elementSlider('Hue Rotation (deg)', 0, 360, 0, v=>{ const img = activeImage(); if(!img) return; const f = ensureFilter(img, F.HueRotation); if(f){ f.rotation = v * Math.PI/180; img.applyFilters(); canvas.renderAll(); } }));
      break;

    // ---------- FILTER ----------
    case 'blur':
      controlPanel.appendChild(elementSlider('Blur (0..1)', 0, 1, 0, v=>{ const img = activeImage(); if(!img) return; const f = ensureFilter(img, F.Blur); if(f){ f.blur = parseFloat(v); img.applyFilters(); canvas.renderAll(); } }));
      break;
    case 'sharpen':
      controlPanel.appendChild(elementSlider('Sharpen (0..1)', 0, 1, 0, v=>{ const img = activeImage(); if(!img) return; // Convolute sharpen kernel
          const a = parseFloat(v);
          const k = [0,-a,0,-a,1+4*a,-a,0,-a,0];
          // remove existing Convolute filters
          img.filters = (img.filters||[]).filter(x=>!(x && x.type === 'Convolute'));
          img.filters.push(new F.Convolute({ matrix:k }));
          img.applyFilters(); canvas.renderAll();
        }));
      break;
    case 'bw':
      controlPanel.appendChild(elementToggle('Toggle B&W', false, checked=>{ const img = activeImage(); if(!img) return; if(checked){ const f = ensureFilter(img, F.Grayscale); img.applyFilters(); canvas.renderAll(); } else { img.filters = (img.filters||[]).filter(x=>!(x && x.type==='Grayscale')); img.applyFilters(); canvas.renderAll(); } }));
      break;
    case 'vintage':
      controlPanel.appendChild(elementButton('Apply Vintage Overlay', ()=>{ overlayVintage(); }));
      break;

    // ---------- EFFECT ----------
    case 'vignette':
      controlPanel.appendChild(elementSlider('Vignette Strength', 0, 1, 0.4, v=>{ applyVignette(parseFloat(v)); }));
      break;
    case 'grain':
      controlPanel.appendChild(elementToggle('Toggle Grain', false, checked=>{ toggleGrain(checked); }));
      break;
    case 'glow':
      controlPanel.appendChild(elementToggle('Toggle Glow', false, checked=>{ toggleGlow(checked); }));
      break;

    // ---------- TEXT ----------
    case 'add_text':
      controlPanel.appendChild(elementButton('Add Text', ()=>{ const t = new fabric.Textbox('New Text',{ left:50, top:50, fontSize:28, fill:'#061428' }); canvas.add(t).setActiveObject(t); }));
      break;
    case 'font_size':
      controlPanel.appendChild(elementSlider('Font Size', 8, 120, 28, v=>{ const o = activeObject(); if(o && o.type === 'textbox'){ o.set('fontSize', parseInt(v)); canvas.renderAll(); } }));
      break;
    case 'font_color':
      controlPanel.appendChild(elementColor('Font Color', '#000000', v=>{ const o = activeObject(); if(o && o.type === 'textbox'){ o.set('fill', v); canvas.renderAll(); } }));
      break;

    // ---------- STICKER ----------
    case 'add_sticker':
      controlPanel.appendChild(elementButton('Add Sticker (emoji)', ()=>{ const t = new fabric.Text('ðŸ˜Š',{ left:80, top:80, fontSize:48 }); canvas.add(t).setActiveObject(t); }));
      break;
    case 'sticker_scale':
      controlPanel.appendChild(elementSlider('Sticker Scale', 0.2, 3, 1, v=>{ const o = activeObject(); if(o){ o.scale(parseFloat(v)); o.setCoords(); canvas.renderAll(); } }));
      break;

    // ---------- BRUSH ----------
    case 'draw_mode':
      controlPanel.appendChild(elementToggle('Drawing Mode', canvas.isDrawingMode, v=>{ canvas.isDrawingMode = v; if(v && !canvas.freeDrawingBrush) canvas.freeDrawingBrush = new fabric.PencilBrush(canvas); }));
      break;
    case 'brush_size':
      controlPanel.appendChild(elementSlider('Brush Size', 1, 80, 6, v=>{ if(canvas.freeDrawingBrush) canvas.freeDrawingBrush.width = parseFloat(v); }));
      break;
    case 'brush_color':
      controlPanel.appendChild(elementColor('Brush Color', '#000000', v=>{ if(!canvas.freeDrawingBrush) canvas.freeDrawingBrush = new fabric.PencilBrush(canvas); canvas.freeDrawingBrush.color = v; }));
      break;

    // ---------- FRAME ----------
    case 'add_frame':
      controlPanel.appendChild(elementButton('Add Simple Frame', ()=>{ if(frameObject) canvas.remove(frameObject); frameObject = new fabric.Rect({ left:6, top:6, width: canvas.width-12, height: canvas.height-12, fill:'transparent', stroke:'#0ea5a3', strokeWidth:8, selectable:false, evented:false }); canvas.add(frameObject); canvas.bringToFront(frameObject); }));
      break;
    case 'remove_frame':
      controlPanel.appendChild(elementButton('Remove Frame', ()=>{ if(frameObject) { canvas.remove(frameObject); frameObject = null; } }));
      break;

    default:
      controlPanel.appendChild(elementButton('Not implemented', ()=>alert('Subfitur belum diimplementasikan secara penuh.')));
  }
}

// ---------- utility UI elements ----------
function elementButton(label, onClick) {
  const d = document.createElement('div');
  const b = document.createElement('button');
  b.className = 'btn';
  b.textContent = label;
  b.onclick = onClick;
  d.appendChild(b);
  return d;
}
function elementSlider(label, min, max, value, onChange) {
  const wr = document.createElement('div');
  wr.style.display='grid';
  wr.style.gap='6px';
  const lab = document.createElement('div'); lab.textContent = label; lab.className='small';
  const r = document.createElement('input'); r.type='range'; r.min=min; r.max=max; r.step=(max-min)/200 || 1; r.value=value;
  const val = document.createElement('div'); val.className='small'; val.textContent = r.value;
  r.oninput = ()=>{ val.textContent = r.value; onChange(parseFloat(r.value)); };
  wr.appendChild(lab); wr.appendChild(r); wr.appendChild(val);
  return wr;
}
function elementToggle(label, def, onChange) {
  const wr = document.createElement('div');
  wr.style.display='flex'; wr.style.alignItems='center'; wr.style.gap='10px';
  const lab = document.createElement('div'); lab.textContent = label; lab.className='small';
  const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = def;
  cb.onchange = ()=>onChange(cb.checked);
  wr.appendChild(cb); wr.appendChild(lab);
  return wr;
}
function elementColor(label, def, onChange) {
  const wr = document.createElement('div');
  wr.style.display='flex'; wr.style.alignItems='center'; wr.style.gap='8px';
  const lab = document.createElement('div'); lab.textContent = label; lab.className='small';
  const inp = document.createElement('input'); inp.type='color'; inp.value = def;
  inp.oninput = ()=>onChange(inp.value);
  wr.appendChild(lab); wr.appendChild(inp);
  return wr;
}

// ---------- visual effects helpers ----------
function overlayVintage(){
  // simple semi-transparent warm overlay
  const rect = new fabric.Rect({ left:0, top:0, width: canvas.width, height: canvas.height, selectable:false, evented:false, fill:'rgba(244,196,127,0.12)' });
  canvas.add(rect); canvas.sendToBack(rect); canvas.renderAll();
}
function applyVignette(strength){
  // create radial gradient overlay
  const circle = new fabric.Circle({ left:0, top:0, radius: Math.max(canvas.width, canvas.height), originX:'left', originY:'top', selectable:false, evented:false });
  const g = new fabric.Gradient({ type:'radial', coords:{ x1: canvas.width/2, y1: canvas.height/2, r1: Math.max(canvas.width, canvas.height)/4, x2: canvas.width/2, y2: canvas.height/2, r2: Math.max(canvas.width, canvas.height)/1 }, colorStops:[ { offset:0, color: 'rgba(0,0,0,0)' }, { offset:1, color: `rgba(0,0,0,${strength})` } ] });
  circle.set('fill', g);
  // remove previous vignette if any
  const prev = canvas.getObjects().find(o=>o._dsrt_vignette);
  if(prev) canvas.remove(prev);
  circle._dsrt_vignette = true;
  canvas.add(circle); canvas.bringToFront(circle); canvas.renderAll();
}
let grainObj = null;
function toggleGrain(on) {
  if(on) {
    if(grainObj) canvas.remove(grainObj);
    // small noise rectangle using pattern
    const p = document.createElement('canvas'); p.width = p.height = 64;
    const ctx = p.getContext('2d');
    for(let i=0;i<200;i++){ ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.fillRect(Math.random()*64,Math.random()*64,1,1); }
    grainObj = new fabric.Rect({ left:0, top:0, width:canvas.width, height:canvas.height, selectable:false, evented:false, fill: new fabric.Pattern({ source:p, repeat:'repeat' }) });
    canvas.add(grainObj); canvas.bringToFront(grainObj); canvas.renderAll();
  } else {
    if(grainObj){ canvas.remove(grainObj); grainObj = null; canvas.renderAll(); }
  }
}
let glowObj = null;
function toggleGlow(on) {
  if(on) {
    if(glowObj) canvas.remove(glowObj);
    glowObj = new fabric.Rect({ left:0, top:0, width:canvas.width, height:canvas.height, selectable:false, evented:false, fill:'rgba(255,240,200,0.06)' });
    canvas.add(glowObj); canvas.bringToFront(glowObj); canvas.renderAll();
  } else {
    if(glowObj){ canvas.remove(glowObj); glowObj=null; canvas.renderAll(); }
  }
}

// ---------- init select first tile (rotate) ----------
selectTile(TILES[0]);

</script>
</body>
</html>
